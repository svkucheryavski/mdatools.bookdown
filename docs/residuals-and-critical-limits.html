<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Residuals and critical limits | Getting started with mdatools for R</title>
  <meta name="description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Residuals and critical limits | Getting started with mdatools for R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  <meta name="github-repo" content="svkucheryavski/mdatools.bookdown" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Residuals and critical limits | Getting started with mdatools for R" />
  
  <meta name="twitter:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  

<meta name="author" content="Sergey Kucheryavskiy" />


<meta name="date" content="2020-02-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="plotting-methods.html"/>
<link rel="next" href="model-complexity.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="what-is-new.html"><a href="what-is-new.html"><i class="fa fa-check"></i>What is new</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="what-mdatools-can-do.html"><a href="what-mdatools-can-do.html"><i class="fa fa-check"></i>What mdatools can do?</a></li>
<li class="chapter" data-level="" data-path="how-to-install.html"><a href="how-to-install.html"><i class="fa fa-check"></i>How to install</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets-and-plots.html"><a href="datasets-and-plots.html"><i class="fa fa-check"></i>Datasets and plots</a>
<ul>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html"><i class="fa fa-check"></i>Attributes and factors</a>
<ul>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#package-specific-attributes"><i class="fa fa-check"></i>Package specific attributes</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#attributes-for-plots"><i class="fa fa-check"></i>Attributes for plots</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#special-methods-for-data-transformations"><i class="fa fa-check"></i>Special methods for data transformations</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#data-frames-with-factors"><i class="fa fa-check"></i>Data frames with factors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html"><i class="fa fa-check"></i>Simple plots</a>
<ul>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#scatter-plots"><i class="fa fa-check"></i>Scatter plots</a></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#line-plots"><i class="fa fa-check"></i>Line plots</a></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#bar-and-errorbar-plots"><i class="fa fa-check"></i>Bar and errorbar plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html"><i class="fa fa-check"></i>Plots for groups of objects</a>
<ul>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#one-matrix-or-data-frame"><i class="fa fa-check"></i>One matrix or data frame</a></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#list-with-matrices-or-data-frames"><i class="fa fa-check"></i>List with matrices or data frames</a></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#use-factors-to-split-a-dataset-into-groups"><i class="fa fa-check"></i>Use factors to split a dataset into groups</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="working-with-images.html"><a href="working-with-images.html"><i class="fa fa-check"></i>Working with images</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i>Preprocessing</a>
<ul>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#autoscaling"><i class="fa fa-check"></i>Autoscaling</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#correction-of-spectral-baseline"><i class="fa fa-check"></i>Correction of spectral baseline</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#smoothing-and-derivatives"><i class="fa fa-check"></i>Smoothing and derivatives</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="principal-component-analysis.html"><a href="principal-component-analysis.html"><i class="fa fa-check"></i>Principal component analysis</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html#model-calibration"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html#model-validation"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#support-for-images"><i class="fa fa-check"></i>Support for images</a></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#manual-x-values-for-loading-line-plot"><i class="fa fa-check"></i>Manual x-values for loading line plot</a></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#excluding-rows-and-columns"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html"><i class="fa fa-check"></i>Residuals and critical limits</a>
<ul>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html#distance-to-model-and-score-distance"><i class="fa fa-check"></i>Distance to model and score distance</a></li>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html#critical-limits"><i class="fa fa-check"></i>Critical limits</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-complexity.html"><a href="model-complexity.html"><i class="fa fa-check"></i>Model complexity</a></li>
<li class="chapter" data-level="" data-path="randomized-pca-algorithms.html"><a href="randomized-pca-algorithms.html"><i class="fa fa-check"></i>Randomized PCA algorithms</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simcadd-simca-classification.html"><a href="simcadd-simca-classification.html"><i class="fa fa-check"></i>SIMCA/DD-SIMCA classification</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html"><i class="fa fa-check"></i>Calibration and validation</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#cross-validation"><i class="fa fa-check"></i>Cross-validation</a></li>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#predictions-and-validation-with-a-test-set"><i class="fa fa-check"></i>Predictions and validation with a test set</a></li>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#class-belonging-probabilities"><i class="fa fa-check"></i>Class belonging probabilities</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multiclass-classification.html"><a href="multiclass-classification.html"><i class="fa fa-check"></i>Multiclass classification</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="partial-least-squares-regression.html"><a href="partial-least-squares-regression.html"><i class="fa fa-check"></i>Partial least squares regression</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html#model-calibration-1"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html#model-validation-1"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plotting-methods-1.html"><a href="plotting-methods-1.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="plotting-methods-1.html"><a href="plotting-methods-1.html#excluding-rows-and-columns-1"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="variable-selection.html"><a href="variable-selection.html"><i class="fa fa-check"></i>Variable selection</a></li>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html"><i class="fa fa-check"></i>Distances and outlier detection</a>
<ul>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html#residual-distance-for-x-decomposition"><i class="fa fa-check"></i>Residual distance for X-decomposition</a></li>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html#residual-distance-for-y-decomposition-and-total-distance"><i class="fa fa-check"></i>Residual distance for Y-decomposition and total distance</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="randomization-test.html"><a href="randomization-test.html"><i class="fa fa-check"></i>Randomization test</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls-discriminant-analysis.html"><a href="pls-discriminant-analysis.html"><i class="fa fa-check"></i>PLS Discriminant Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-of-pls-da-model.html"><a href="calibration-of-pls-da-model.html"><i class="fa fa-check"></i>Calibration of PLS-DA model</a></li>
<li class="chapter" data-level="" data-path="classification-plots.html"><a href="classification-plots.html"><i class="fa fa-check"></i>Classification plots</a></li>
<li class="chapter" data-level="" data-path="performance-plots.html"><a href="performance-plots.html"><i class="fa fa-check"></i>Performance plots</a></li>
<li class="chapter" data-level="" data-path="predictions-for-a-new-data.html"><a href="predictions-for-a-new-data.html"><i class="fa fa-check"></i>Predictions for a new data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html"><i class="fa fa-check"></i>Interval PLS</a>
<ul>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html#forward-ipls"><i class="fa fa-check"></i>Forward iPLS</a></li>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html#backward-ipls"><i class="fa fa-check"></i>Backward iPLS</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Getting started with mdatools for R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="residuals-and-critical-limits" class="section level2">
<h2>Residuals and critical limits</h2>
<div id="distance-to-model-and-score-distance" class="section level3">
<h3>Distance to model and score distance</h3>
<p>As it was written in the brief theoretical section about PCA, when data objects are being projected to a principal component space, two distances are calculated and stored as a part of PCA results (<code>pcares</code> object). The first is a squared orthogonal Euclidean distance from original position of an object to the PC space, also known as <em>orthogonal distance</em> and denoted as <em>Q</em> or <em>q</em>. The distance shows how well the object is fitted by the PCA model and allows to detect objects that do not follow a commond trend, captured by the PCs.</p>
<p>The second distance shows how far a projection of an object to the PC space is from the origin. This distance is also known as Hotelling T<sup>2</sup> distance or a <em>score distance</em>. To compute T<sup>2</sup> distance scores should be first normalized by dividing them to corresponding singular values (or eigenvalues if we deal with squared scores). The T<sup>2</sup> distance allows to see extreme objects — which are far from the origin. In the package as well as in this tutorial we will also use letter <span class="math inline">\(h\)</span> to denote this distance, so <span class="math inline">\(Q\)</span> and <span class="math inline">\(q\)</span> are for orthogonal distance and <span class="math inline">\(T^2\)</span> and <span class="math inline">\(h\)</span> stand for the score distance.</p>
<p>In <em>mdatools</em> both distances are calculated for all objects in dataset and all possible components. So every distance is represented by <span class="math inline">\(I \times A\)</span> matrix (will remind here that <span class="math inline">\(I\)</span> is number of objects or rows in data matrix and <span class="math inline">\(A\)</span> is number of components in PCA model), the first column contains distances for a model with only one component, second — for model with two components, and so on. The distances can be visialised using method <code>plotResiduals()</code> which is available both for PCA results as well as for PCA model. In the case of model the plot shows distances both for calibration set and test set (if available).</p>
<p>Here is an example, where I split People data to calibration and test set as in one of the examples in previous sections and show residuals for model and result objects.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="residuals-and-critical-limits.html#cb85-1"></a><span class="kw">data</span>(people)</span>
<span id="cb85-2"><a href="residuals-and-critical-limits.html#cb85-2"></a>idx =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">4</span>, <span class="dv">32</span>, <span class="dv">4</span>)</span>
<span id="cb85-3"><a href="residuals-and-critical-limits.html#cb85-3"></a>Xc =<span class="st"> </span>people[<span class="op">-</span>idx, ]</span>
<span id="cb85-4"><a href="residuals-and-critical-limits.html#cb85-4"></a>Xt =<span class="st"> </span>people[idx, ]</span>
<span id="cb85-5"><a href="residuals-and-critical-limits.html#cb85-5"></a></span>
<span id="cb85-6"><a href="residuals-and-critical-limits.html#cb85-6"></a>m =<span class="st"> </span><span class="kw">pca</span>(Xc, <span class="dv">4</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">x.test =</span> Xt)</span>
<span id="cb85-7"><a href="residuals-and-critical-limits.html#cb85-7"></a></span>
<span id="cb85-8"><a href="residuals-and-critical-limits.html#cb85-8"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb85-9"><a href="residuals-and-critical-limits.html#cb85-9"></a><span class="kw">plotResiduals</span>(m, <span class="dt">main =</span> <span class="st">&quot;Residuals for model&quot;</span>)</span>
<span id="cb85-10"><a href="residuals-and-critical-limits.html#cb85-10"></a><span class="kw">plotResiduals</span>(m, <span class="dt">ncomp =</span> <span class="dv">2</span>, <span class="dt">main =</span> <span class="st">&quot;Residuals for model (2 Comp)&quot;</span>)</span>
<span id="cb85-11"><a href="residuals-and-critical-limits.html#cb85-11"></a><span class="kw">plotResiduals</span>(m<span class="op">$</span>res<span class="op">$</span>cal, <span class="dt">main =</span> <span class="st">&quot;Residuals for calibration set&quot;</span>)</span>
<span id="cb85-12"><a href="residuals-and-critical-limits.html#cb85-12"></a><span class="kw">plotResiduals</span>(m<span class="op">$</span>res<span class="op">$</span>test, <span class="dt">main =</span> <span class="st">&quot;Residuals for test set&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-66-1.png" width="864" /></p>
<p>As it was briefly mentioned before, if residual/distance plot is made for a model, it also shows two critical limits: the dashed line is a limit for extreme objects and the dotted line is a limit for outliers. How they are computed is explained later in this section. If you want to hide them, just use additional parameter <code>show.limits = FALSE</code>. You can also change the color, line type and width for the lines by using options <code>lim.col</code>, <code>lim.lty</code> and <code>lim.lwd</code> as it is shown below.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="residuals-and-critical-limits.html#cb86-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb86-2"><a href="residuals-and-critical-limits.html#cb86-2"></a><span class="kw">plotResiduals</span>(m, <span class="dt">show.limits =</span> <span class="ot">FALSE</span>)</span>
<span id="cb86-3"><a href="residuals-and-critical-limits.html#cb86-3"></a><span class="kw">plotResiduals</span>(m, <span class="dt">lim.col =</span> <span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;orange&quot;</span>), <span class="dt">lim.lwd =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>), <span class="dt">lim.lty =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-67-1.png" width="864" /></p>
<p>It is necessary to provide a vector with two values for each of the argument (first for extreme objects and second for outliers border).</p>
<p>Finally, you can also notice that for model plot the distance values are normalized (<span class="math inline">\(h/h_0\)</span> and <span class="math inline">\(q/q_0\)</span> instead of just <span class="math inline">\(h\)</span> and <span class="math inline">\(q\)</span>). This is needed to show the limits correctly and, again, will be explained in detail below. You can switch this option by using logical parameter <code>norm</code>. Sometimes, it is also make sense to use log tranform for the values, which can be switched by using parameter <code>log</code>. Code below shows example for using these parameters.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="residuals-and-critical-limits.html#cb87-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb87-2"><a href="residuals-and-critical-limits.html#cb87-2"></a><span class="kw">plotResiduals</span>(m, <span class="dt">norm =</span> <span class="ot">FALSE</span>)</span>
<span id="cb87-3"><a href="residuals-and-critical-limits.html#cb87-3"></a><span class="kw">plotResiduals</span>(m, <span class="dt">norm =</span> <span class="ot">TRUE</span>)</span>
<span id="cb87-4"><a href="residuals-and-critical-limits.html#cb87-4"></a><span class="kw">plotResiduals</span>(m, <span class="dt">norm =</span> <span class="ot">TRUE</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</span>
<span id="cb87-5"><a href="residuals-and-critical-limits.html#cb87-5"></a><span class="kw">plotResiduals</span>(m, <span class="dt">norm =</span> <span class="ot">FALSE</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-68-1.png" width="864" /></p>
</div>
<div id="critical-limits" class="section level3">
<h3>Critical limits</h3>
<p>If PCA model is made for dataset taken from the same poulation, the orthogonal and score distances can be used to find outliers and extreme objects. One of the ways to do this is to compute critical limits for the distances assuming that they follow certain theoretical distribution.</p>
<p>Critical limits are also important for SIMCA classification as they are directly used for making decision on class belongings. This package implements several methods to compute the limits, which are explained in this section.</p>
<div id="data-driven-approach" class="section level4">
<h4>Data driven approach</h4>
<p>Starting from version 0.10.0, by default the limits are computed using data driven approach <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/cem.1147">proposed</a> and then <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/cem.2506">extended</a> by Pomerantsev and Rodionova.</p>
<p>It was known before, that both distances are well described by chi-square distribution. The distribution in general describes behaviour of sum of squared random values taken from standardized normal distribution, which means, that the distances has to be standardized first. The scaling factor as well as number of degrees of freedom (DoF) can be estimated from the distance values — hence the name (data driven).</p>
<p>Since the estimation procedure is identical for the both distances, we will use a generalized version. Let’s say we have a vector of distance values <span class="math inline">\(u\)</span> (where <span class="math inline">\(u\)</span> can be either score distance values, <span class="math inline">\(h\)</span>, or orthogonal distance values, <span class="math inline">\(q\)</span>) for given number of components. Then the scaling factor, <span class="math inline">\(u_0\)</span> and corresponding DoF, <span class="math inline">\(N_u\)</span> can be found as:</p>
<p><span class="math display">\[u_0 = m_u = \frac{1}{I} \sum_{i = 1}^{I} u\]</span>
<span class="math display">\[N_u = \mathrm{int} \bigg( \frac{2u_0^2}{s_u^2} \bigg)\]</span></p>
<p>Here <span class="math inline">\(s_u^2\)</span> is a variance of the distances. Then the the normalized distance values will follow chi-square distribution with <span class="math inline">\(N_u\)</span> degrees of freedom (just replace <span class="math inline">\(u\)</span> to <span class="math inline">\(q\)</span> or <span class="math inline">\(h\)</span> to get the formula for particular distance):</p>
<p><span class="math display">\[N_u \frac{u}{u_0} \propto \chi^2(N_u)\]</span></p>
<p>However, this does not take into account the fact that <span class="math inline">\(h\)</span> and <span class="math inline">\(q\)</span> are, strictly speaking, not independent. It is well known that adding an additional component to PCA model leads to increase of score distance and decrease of residual distance and removing a component has the opposite effect. This relationship can be taken into account by computing a joint or a <em>full distance</em>, <span class="math inline">\(f\)</span>, as follows:</p>
<p><span class="math display">\[f = N_h \frac{h}{h_0} + N_q \frac{q}{q_0}\]</span></p>
<p>The full distance, <span class="math inline">\(f\)</span> also follows chi-square distribition with degrees of freedom: <span class="math inline">\(N_f = N_q + N_h\)</span>. The critical limits for the full distance are computed using inverse cumulative distribution function (ICDF) also known as quantile function. For extreme objects (shown on distance plot as dashed line) as:</p>
<p><span class="math display">\[f_{crit} = \chi^{-2}(1 - \alpha, N_f)\]</span></p>
<p>Where <span class="math inline">\(\alpha\)</span> is a significance level — expected number of extreme objects (e.g. for <span class="math inline">\(\alpha = 0.05\)</span> we expect that 5% of objects will be categorized as extreme). Critical limit for outliers is found as:</p>
<p><span class="math display">\[f_{crit} = \chi^{-2}((1 - \gamma)^{1/I}, N_f)\]</span></p>
<p>Here <span class="math inline">\(\gamma\)</span> is a significance level for outliers, so if it is <span class="math inline">\(0.01\)</span> every object has <span class="math inline">\(1\%\)</span> chance to be detected as outlier. The test for outliers should treat every object independently, so it requires Bonferroni correction, as one can see from the formula.</p>
<p>You can change the significance level both for exreme objects and outliers either when you calibrate the model, by providing parameters <code>alpha</code> and <code>gamma</code>, or for existent model, by using function <code>setDistanceLimits()</code> as shown in the example below.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="residuals-and-critical-limits.html#cb88-1"></a><span class="co"># calbrate a model with alpha = 5% and gamma = 5%</span></span>
<span id="cb88-2"><a href="residuals-and-critical-limits.html#cb88-2"></a>m =<span class="st"> </span><span class="kw">pca</span>(people, <span class="dv">4</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">gamma =</span> <span class="fl">0.05</span>)</span>
<span id="cb88-3"><a href="residuals-and-critical-limits.html#cb88-3"></a></span>
<span id="cb88-4"><a href="residuals-and-critical-limits.html#cb88-4"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb88-5"><a href="residuals-and-critical-limits.html#cb88-5"></a><span class="kw">plotResiduals</span>(m)</span>
<span id="cb88-6"><a href="residuals-and-critical-limits.html#cb88-6"></a></span>
<span id="cb88-7"><a href="residuals-and-critical-limits.html#cb88-7"></a><span class="co"># change both levels to 1%</span></span>
<span id="cb88-8"><a href="residuals-and-critical-limits.html#cb88-8"></a>m =<span class="st"> </span><span class="kw">setDistanceLimits</span>(m, <span class="dt">alpha =</span> <span class="fl">0.01</span>, <span class="dt">gamma =</span> <span class="fl">0.01</span>)</span>
<span id="cb88-9"><a href="residuals-and-critical-limits.html#cb88-9"></a><span class="kw">plotResiduals</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-69-1.png" width="864" /></p>
<p>This function also allows to change method for computing the limits, which is discussed in next subsection.</p>
</div>
<div id="other-methods-for-computing-critical-limits" class="section level4">
<h4>Other methods for computing critical limits</h4>
<p>The package implements several other methods for computing critical limits for residuals distances. The needed method can be selected by providing additional argument, <code>lim.type</code>, both when calibrate PCA model or when adjust the limits for existent model with <code>setDistanceLimits()</code> function. By default, <code>lim.type = "ddmoments"</code>, which corresponds to the method described above — data driven approach based on classical estimators (statistical moments).</p>
<p>When data is contaminated with outliers, using statistical moments may lead to wrong estimators, in this case it is recommended to use robust version instead by specifying <code>lim.type = "ddrobust"</code>. The robust approach utilizes median and inter-quartile range instead of mean and standard deviation (see <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/cem.2506">the paper</a> for details). The use of robust and classical data driven approaches also helps to identify a proper model complexity, which will be discussed in the next section.</p>
<p>In addition to the data driven method, <em>mdatools</em>, also allows to use state-of-art approach, where limits for each distance are computed independently giving rectangular acceptance area on the distance plot. In this case, two methods are available for the orthogonal distance: either based on chi-square distribution but only for <span class="math inline">\(q\)</span> values (<code>lim.type="chisq"</code>) or using Jackson-Mudholkar method (<code>lim.type="jm"</code>). If one of the two methods is selected, critical limits for the score distances, <span class="math inline">\(h\)</span>, will be computed using <a href="https://en.wikipedia.org/wiki/Hotelling%27s_T-squared_distribution">Hotelling’s T<sup>2</sup> distribution</a>. This way of computing critical limits can be found in many popular chemometric software, for example, PLS_Toolbox.</p>
</div>
<div id="categorization-of-data-rows-based-on-critical-limits" class="section level4">
<h4>Categorization of data rows based on critical limits</h4>
<p>It is possible to categorize every row (object, measurement) in a dataset based on the two distances and critical limits computed for given model and limit paramters (method and significance limit). Function <code>categorize()</code> is made for that. An example below shows how to categorize new predictions using this function.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="residuals-and-critical-limits.html#cb89-1"></a><span class="kw">data</span>(people)</span>
<span id="cb89-2"><a href="residuals-and-critical-limits.html#cb89-2"></a></span>
<span id="cb89-3"><a href="residuals-and-critical-limits.html#cb89-3"></a>idx =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">4</span>, <span class="dv">32</span>, <span class="dv">4</span>)</span>
<span id="cb89-4"><a href="residuals-and-critical-limits.html#cb89-4"></a>Xc =<span class="st"> </span>people[<span class="op">-</span>idx, ]</span>
<span id="cb89-5"><a href="residuals-and-critical-limits.html#cb89-5"></a>Xt =<span class="st"> </span>people[idx, ]</span>
<span id="cb89-6"><a href="residuals-and-critical-limits.html#cb89-6"></a></span>
<span id="cb89-7"><a href="residuals-and-critical-limits.html#cb89-7"></a>m =<span class="st"> </span><span class="kw">pca</span>(Xc, <span class="dv">4</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>)</span>
<span id="cb89-8"><a href="residuals-and-critical-limits.html#cb89-8"></a>r =<span class="st"> </span><span class="kw">predict</span>(m, Xt)</span>
<span id="cb89-9"><a href="residuals-and-critical-limits.html#cb89-9"></a></span>
<span id="cb89-10"><a href="residuals-and-critical-limits.html#cb89-10"></a>c =<span class="st"> </span><span class="kw">categorize</span>(m, r)</span>
<span id="cb89-11"><a href="residuals-and-critical-limits.html#cb89-11"></a><span class="kw">print</span>(c)</span></code></pre></div>
<pre><code>## [1] outlier regular regular regular extreme regular outlier
## [8] regular
## Levels: regular extreme outlier</code></pre>
<p>As one can see, there are two outliers, one extreme and five regulat objects. This can be visualised on distance plot:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="residuals-and-critical-limits.html#cb91-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb91-2"><a href="residuals-and-critical-limits.html#cb91-2"></a><span class="kw">plotResiduals</span>(r, <span class="dt">cgroup =</span> c)</span>
<span id="cb91-3"><a href="residuals-and-critical-limits.html#cb91-3"></a><span class="kw">plotResiduals</span>(m, <span class="dt">res =</span> <span class="kw">list</span>(<span class="st">&quot;new&quot;</span> =<span class="st"> </span>r), <span class="dt">cgroup =</span> c)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-71-1.png" width="864" /></p>
<p>The first plot is a normal distance/residuals plot for results, while the second plot is made for model with manually specified result list. The last has possibility to show critical limits and see why actually the objects have been categorized like this.</p>
<p>When the plot is made for calibration set, this option can be simplified by providing specific value for parameter <code>cgroup</code> as shown below.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="residuals-and-critical-limits.html#cb92-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb92-2"><a href="residuals-and-critical-limits.html#cb92-2"></a><span class="kw">plotResiduals</span>(m)</span>
<span id="cb92-3"><a href="residuals-and-critical-limits.html#cb92-3"></a><span class="kw">plotResiduals</span>(m, <span class="dt">cgroup =</span> <span class="st">&quot;categories&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-72-1.png" width="864" /></p>
<p>This option will work only if plot is made for one result object.</p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="plotting-methods.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="model-complexity.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 1
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
