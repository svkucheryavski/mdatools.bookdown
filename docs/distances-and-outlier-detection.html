<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Distances and outlier detection | Getting started with mdatools for R</title>
  <meta name="description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Distances and outlier detection | Getting started with mdatools for R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  <meta name="github-repo" content="svkucheryavski/mdatools.bookdown" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Distances and outlier detection | Getting started with mdatools for R" />
  
  <meta name="twitter:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualise results for one method, he or she can easily do this for the others." />
  

<meta name="author" content="Sergey Kucheryavskiy" />


<meta name="date" content="2020-02-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="variable-selection.html"/>
<link rel="next" href="randomization-test.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="what-is-new.html"><a href="what-is-new.html"><i class="fa fa-check"></i>What is new</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="what-mdatools-can-do.html"><a href="what-mdatools-can-do.html"><i class="fa fa-check"></i>What mdatools can do?</a></li>
<li class="chapter" data-level="" data-path="how-to-install.html"><a href="how-to-install.html"><i class="fa fa-check"></i>How to install</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets-and-plots.html"><a href="datasets-and-plots.html"><i class="fa fa-check"></i>Datasets and plots</a>
<ul>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html"><i class="fa fa-check"></i>Attributes and factors</a>
<ul>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#package-specific-attributes"><i class="fa fa-check"></i>Package specific attributes</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#attributes-for-plots"><i class="fa fa-check"></i>Attributes for plots</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#special-methods-for-data-transformations"><i class="fa fa-check"></i>Special methods for data transformations</a></li>
<li class="chapter" data-level="" data-path="attributes-and-factors.html"><a href="attributes-and-factors.html#data-frames-with-factors"><i class="fa fa-check"></i>Data frames with factors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html"><i class="fa fa-check"></i>Simple plots</a>
<ul>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#scatter-plots"><i class="fa fa-check"></i>Scatter plots</a></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#line-plots"><i class="fa fa-check"></i>Line plots</a></li>
<li class="chapter" data-level="" data-path="simple-plots.html"><a href="simple-plots.html#bar-and-errorbar-plots"><i class="fa fa-check"></i>Bar and errorbar plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html"><i class="fa fa-check"></i>Plots for groups of objects</a>
<ul>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#one-matrix-or-data-frame"><i class="fa fa-check"></i>One matrix or data frame</a></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#list-with-matrices-or-data-frames"><i class="fa fa-check"></i>List with matrices or data frames</a></li>
<li class="chapter" data-level="" data-path="plots-for-groups-of-objects.html"><a href="plots-for-groups-of-objects.html#use-factors-to-split-a-dataset-into-groups"><i class="fa fa-check"></i>Use factors to split a dataset into groups</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="working-with-images.html"><a href="working-with-images.html"><i class="fa fa-check"></i>Working with images</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i>Preprocessing</a>
<ul>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#autoscaling"><i class="fa fa-check"></i>Autoscaling</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#correction-of-spectral-baseline"><i class="fa fa-check"></i>Correction of spectral baseline</a></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html#smoothing-and-derivatives"><i class="fa fa-check"></i>Smoothing and derivatives</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="principal-component-analysis.html"><a href="principal-component-analysis.html"><i class="fa fa-check"></i>Principal component analysis</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html#model-calibration"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="models-and-results.html"><a href="models-and-results.html#model-validation"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#support-for-images"><i class="fa fa-check"></i>Support for images</a></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#manual-x-values-for-loading-line-plot"><i class="fa fa-check"></i>Manual x-values for loading line plot</a></li>
<li class="chapter" data-level="" data-path="plotting-methods.html"><a href="plotting-methods.html#excluding-rows-and-columns"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html"><i class="fa fa-check"></i>Residuals and critical limits</a>
<ul>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html#distance-to-model-and-score-distance"><i class="fa fa-check"></i>Distance to model and score distance</a></li>
<li class="chapter" data-level="" data-path="residuals-and-critical-limits.html"><a href="residuals-and-critical-limits.html#critical-limits"><i class="fa fa-check"></i>Critical limits</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-complexity.html"><a href="model-complexity.html"><i class="fa fa-check"></i>Model complexity</a></li>
<li class="chapter" data-level="" data-path="randomized-pca-algorithms.html"><a href="randomized-pca-algorithms.html"><i class="fa fa-check"></i>Randomized PCA algorithms</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simcadd-simca-classification.html"><a href="simcadd-simca-classification.html"><i class="fa fa-check"></i>SIMCA/DD-SIMCA classification</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html"><i class="fa fa-check"></i>Calibration and validation</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#cross-validation"><i class="fa fa-check"></i>Cross-validation</a></li>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#predictions-and-validation-with-a-test-set"><i class="fa fa-check"></i>Predictions and validation with a test set</a></li>
<li class="chapter" data-level="" data-path="calibration-and-validation.html"><a href="calibration-and-validation.html#class-belonging-probabilities"><i class="fa fa-check"></i>Class belonging probabilities</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multiclass-classification.html"><a href="multiclass-classification.html"><i class="fa fa-check"></i>Multiclass classification</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="partial-least-squares-regression.html"><a href="partial-least-squares-regression.html"><i class="fa fa-check"></i>Partial least squares regression</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html#model-calibration-1"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="models-and-results-1.html"><a href="models-and-results-1.html#model-validation-1"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plotting-methods-1.html"><a href="plotting-methods-1.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="plotting-methods-1.html"><a href="plotting-methods-1.html#excluding-rows-and-columns-1"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="variable-selection.html"><a href="variable-selection.html"><i class="fa fa-check"></i>Variable selection</a></li>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html"><i class="fa fa-check"></i>Distances and outlier detection</a>
<ul>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html#residual-distance-for-x-decomposition"><i class="fa fa-check"></i>Residual distance for X-decomposition</a></li>
<li class="chapter" data-level="" data-path="distances-and-outlier-detection.html"><a href="distances-and-outlier-detection.html#residual-distance-for-y-decomposition-and-total-distance"><i class="fa fa-check"></i>Residual distance for Y-decomposition and total distance</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="randomization-test.html"><a href="randomization-test.html"><i class="fa fa-check"></i>Randomization test</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls-discriminant-analysis.html"><a href="pls-discriminant-analysis.html"><i class="fa fa-check"></i>PLS Discriminant Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="calibration-of-pls-da-model.html"><a href="calibration-of-pls-da-model.html"><i class="fa fa-check"></i>Calibration of PLS-DA model</a></li>
<li class="chapter" data-level="" data-path="classification-plots.html"><a href="classification-plots.html"><i class="fa fa-check"></i>Classification plots</a></li>
<li class="chapter" data-level="" data-path="performance-plots.html"><a href="performance-plots.html"><i class="fa fa-check"></i>Performance plots</a></li>
<li class="chapter" data-level="" data-path="predictions-for-a-new-data.html"><a href="predictions-for-a-new-data.html"><i class="fa fa-check"></i>Predictions for a new data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html"><i class="fa fa-check"></i>Interval PLS</a>
<ul>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html#forward-ipls"><i class="fa fa-check"></i>Forward iPLS</a></li>
<li class="chapter" data-level="" data-path="interval-pls.html"><a href="interval-pls.html#backward-ipls"><i class="fa fa-check"></i>Backward iPLS</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Getting started with mdatools for R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="distances-and-outlier-detection" class="section level2">
<h2>Distances and outlier detection</h2>
<div id="residual-distance-for-x-decomposition" class="section level3">
<h3>Residual distance for X-decomposition</h3>
<p>For decomposition of X-values the residual distances are computed and treated in the same way as in PCA — via orthogonal and score distances and corresponding critical limits. The <code>pls()</code> constructor takes the three arguments for computing the critical limits, similar to PCA (<code>lim.type</code>, <code>alpha</code>, <code>gamma</code>). The default value for <code>lim.type</code> is the same as for PCA (<code>"ddmoments"</code>). Distance plot can be made using <code>plotXResiduals()</code>, it works identical to <code>plotResiduals()</code> for PCA.</p>
<p>Below is example on how to use the plot.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="distances-and-outlier-detection.html#cb204-1"></a>m =<span class="st"> </span><span class="kw">pls</span>(Xc, yc, <span class="dv">4</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">cv =</span> <span class="dv">1</span>)</span>
<span id="cb204-2"><a href="distances-and-outlier-detection.html#cb204-2"></a></span>
<span id="cb204-3"><a href="distances-and-outlier-detection.html#cb204-3"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb204-4"><a href="distances-and-outlier-detection.html#cb204-4"></a><span class="kw">plotXResiduals</span>(m)</span>
<span id="cb204-5"><a href="distances-and-outlier-detection.html#cb204-5"></a><span class="kw">plotXResiduals</span>(m, <span class="dt">ncomp =</span> <span class="dv">2</span>, <span class="dt">log =</span> <span class="ot">TRUE</span>)</span>
<span id="cb204-6"><a href="distances-and-outlier-detection.html#cb204-6"></a><span class="kw">plotXResiduals</span>(m, <span class="dt">ncomp =</span> <span class="dv">2</span>, <span class="dt">res =</span> <span class="kw">list</span>(<span class="st">&quot;cal&quot;</span> =<span class="st"> </span>m<span class="op">$</span>res<span class="op">$</span>cal))</span>
<span id="cb204-7"><a href="distances-and-outlier-detection.html#cb204-7"></a><span class="kw">plotXResiduals</span>(m<span class="op">$</span>res<span class="op">$</span>cal)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-130-1.png" width="864" /></p>
<p>PLS also has function <code>categorize()</code> which allows to identify extreme objects and outliers. However, it works in a different way and takes into account not only residual distances for X-decomposition but also similar measure for decomposition of Y. This is explained in following sections.</p>
</div>
<div id="residual-distance-for-y-decomposition-and-total-distance" class="section level3">
<h3>Residual distance for Y-decomposition and total distance</h3>
<p>The residual distance for Y-decomposition is calculated in a different way — as a difference between predicted and reference y-values. The difference for selected y-variable is expected to be random and normally distributed. It can be checked visually by using function <code>plotYResiduals()</code> as shown in example below. In this plot the difference is plotted against the reference value.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="distances-and-outlier-detection.html#cb205-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb205-2"><a href="distances-and-outlier-detection.html#cb205-2"></a><span class="kw">plotYResiduals</span>(m)</span>
<span id="cb205-3"><a href="distances-and-outlier-detection.html#cb205-3"></a><span class="kw">plotYResiduals</span>(m, <span class="dt">ncomp =</span> <span class="dv">2</span>)</span>
<span id="cb205-4"><a href="distances-and-outlier-detection.html#cb205-4"></a><span class="kw">plotYResiduals</span>(m, <span class="dt">ncomp =</span> <span class="dv">2</span>, <span class="dt">res =</span> <span class="kw">list</span>(<span class="st">&quot;cal&quot;</span> =<span class="st"> </span>m<span class="op">$</span>res<span class="op">$</span>cal))</span>
<span id="cb205-5"><a href="distances-and-outlier-detection.html#cb205-5"></a><span class="kw">plotYResiduals</span>(m<span class="op">$</span>res<span class="op">$</span>cal)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-131-1.png" width="864" /></p>
<p>Since predictions are also computed for cross-validation, the plot shows the distance values for cross-validated results.</p>
<p>The distance between reference and predicted values can be used to compute orthogonal squared distance, similar to how it is done for X-decomposition, as it is shown below:</p>
<p><span class="math display">\[ z_i = \sum_{k = 1}^K (y_{ik} - \hat{y}_{ik})^2 \]</span></p>
<p>Here <span class="math inline">\(y_{ik}\)</span> is a reference value for sample <span class="math inline">\(i\)</span> and y-variable <span class="math inline">\(k\)</span> and <span class="math inline">\(\hat{y}_{ik}\)</span> is the corresponding predicted value, <span class="math inline">\(K\)</span> is the number of y-variables. Apparently, <span class="math inline">\(z\)</span> values also follow chi-square distribution similar to how <a href="residuals-and-critical-limits.html#critical-limits">it is done in PCA</a>:</p>
<p><span class="math display">\[N_z \frac{z}{z_0} \propto \chi^2(N_z)\]</span></p>
<p>In case of PLS1 (when there is only one y-variable), <span class="math inline">\(N_z = 1\)</span>. Otherwise, both <span class="math inline">\(z_0\)</span> and <span class="math inline">\(N_z\)</span> are computed using <a href="residuals-and-critical-limits.html#data-driven-approach">data driven approach</a>, similar to <span class="math inline">\(q_0\)</span>, <span class="math inline">\(N_q\)</span>, <span class="math inline">\(h_0\)</span>, <span class="math inline">\(N_h\)</span>, using either classical (based on moments) or robust approach.</p>
<p>Full distance for X-decomposition, <span class="math inline">\(f\)</span> and the Y-distance, <span class="math inline">\(z\)</span> can be combined into XY total distance, <span class="math inline">\(g\)</span>:</p>
<p><span class="math display">\[g = N_f\frac{f}{f_0} + N_z\frac{z}{z_0} \propto \chi^2(N_g)\]</span></p>
<p>Here <span class="math inline">\(N_g = N_f + N_z\)</span>. This approach was proposed by Rodionova and Pomerantsev and described in <a href="https://pubs.acs.org/doi/10.1021/acs.analchem.9b04611">this paper</a>. The distances and the critical limits can be visualized using function <code>plotXYResiduals()</code> as illustrated in the next example.</p>
<p>The example is based on People data (prediction of shoesize), however we will first introduce two outliers. We will change response value for row #9 to 25, which is apparently too small value for shoesize of an adult person. The predictor values will be the same. Then we will change height of first person (row #1) to 125 cm, which is again quite small value. And keep the response value unchanged. After that, we create a PLS model with classic data driven approach for computing critical limits and show the XY-residuals plot. Finally, that we change the method for limits to robust and show the plot again:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="distances-and-outlier-detection.html#cb206-1"></a><span class="co"># prepare data</span></span>
<span id="cb206-2"><a href="distances-and-outlier-detection.html#cb206-2"></a><span class="kw">data</span>(people)</span>
<span id="cb206-3"><a href="distances-and-outlier-detection.html#cb206-3"></a>X =<span class="st"> </span>people[, <span class="dv">-4</span>]</span>
<span id="cb206-4"><a href="distances-and-outlier-detection.html#cb206-4"></a>y =<span class="st"> </span>people[, <span class="dv">4</span>, drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb206-5"><a href="distances-and-outlier-detection.html#cb206-5"></a></span>
<span id="cb206-6"><a href="distances-and-outlier-detection.html#cb206-6"></a><span class="co"># add outliers</span></span>
<span id="cb206-7"><a href="distances-and-outlier-detection.html#cb206-7"></a>y[<span class="dv">9</span>] =<span class="st"> </span><span class="dv">25</span></span>
<span id="cb206-8"><a href="distances-and-outlier-detection.html#cb206-8"></a>X[<span class="dv">1</span>, <span class="dv">1</span>] =<span class="st"> </span><span class="dv">125</span></span>
<span id="cb206-9"><a href="distances-and-outlier-detection.html#cb206-9"></a></span>
<span id="cb206-10"><a href="distances-and-outlier-detection.html#cb206-10"></a><span class="co"># create model and show plots</span></span>
<span id="cb206-11"><a href="distances-and-outlier-detection.html#cb206-11"></a>m =<span class="st"> </span><span class="kw">pls</span>(X, y, <span class="dv">4</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">cv =</span> <span class="dv">1</span>, <span class="dt">lim.type =</span> <span class="st">&quot;ddmoments&quot;</span>)</span>
<span id="cb206-12"><a href="distances-and-outlier-detection.html#cb206-12"></a></span>
<span id="cb206-13"><a href="distances-and-outlier-detection.html#cb206-13"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb206-14"><a href="distances-and-outlier-detection.html#cb206-14"></a><span class="kw">plotXYResiduals</span>(m, <span class="dt">show.labels =</span> <span class="ot">TRUE</span>, <span class="dt">labels =</span> <span class="st">&quot;indices&quot;</span>)</span>
<span id="cb206-15"><a href="distances-and-outlier-detection.html#cb206-15"></a></span>
<span id="cb206-16"><a href="distances-and-outlier-detection.html#cb206-16"></a>m =<span class="st"> </span><span class="kw">setDistanceLimits</span>(m, <span class="dt">lim.type =</span> <span class="st">&quot;ddrobust&quot;</span>)</span>
<span id="cb206-17"><a href="distances-and-outlier-detection.html#cb206-17"></a><span class="kw">plotXYResiduals</span>(m, <span class="dt">show.labels =</span> <span class="ot">TRUE</span>, <span class="dt">labels =</span> <span class="st">&quot;indices&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-132-1.png" width="864" /></p>
<p>As one can see, both classic and robust approach detect sample number 9 (with wrong y-value) as a clear outlier. Using robust approach helps to identify the second outlier as well. However, you can see that the location of the two samples is different — sample #9 has large Y-distance (<span class="math inline">\(z/z_0\)</span>), while sample #1 has large full X-distance (<span class="math inline">\(f/f_0\)</span>). Which is in agreement with the way we created the outliers.</p>
<p>The limits shown on the plot are made for the total distance, <span class="math inline">\(g\)</span>. For example, to detect outliers we need to compare the total distance, <span class="math inline">\(g\)</span>, with critical limit computed for predefined significance level, <span class="math inline">\(\gamma\)</span> (shown as dotted line on the plots):</p>
<p><span class="math display">\[g &gt; \chi^{-2} \big( (1 - \gamma)^{1/I}, N_g \big) \]</span></p>
<p>The proper procedure for detection and removing outliers can be found in the <a href="https://pubs.acs.org/doi/10.1021/acs.analchem.9b04611">paper</a> and will be very briefly touched upon here. The detection can be done using function <code>categorize()</code> which works similar to the same function for PCA decomposition — returns vector with categories for each measurement, as shown in an example below:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="distances-and-outlier-detection.html#cb207-1"></a>c =<span class="st"> </span><span class="kw">categorize</span>(m, m<span class="op">$</span>res<span class="op">$</span>cal)</span>
<span id="cb207-2"><a href="distances-and-outlier-detection.html#cb207-2"></a><span class="kw">print</span>(c)</span></code></pre></div>
<pre><code>##  [1] outlier regular regular regular regular regular extreme
##  [8] regular outlier regular regular regular regular regular
## [15] regular regular regular extreme regular regular regular
## [22] regular regular regular regular regular extreme regular
## [29] regular regular regular regular
## Levels: regular extreme outlier</code></pre>
<p>A simplified description of the recommended procedure proposed in the <a href="https://pubs.acs.org/doi/10.1021/acs.analchem.9b04611">mentioned paper</a> is following:</p>
<ol style="list-style-type: decimal">
<li>Make a PLS model with robust estimator of critical limits</li>
<li>Detect outliers if any, remove them and keep the removed objects separately</li>
<li>Repeat steps 1-2 until no outliers are detected</li>
<li>Apply model to the collected outliers (use <code>predict</code>)</li>
<li>If any of them appear as regular objects, return them back to the dataset and go to step 1</li>
<li>Repeat all steps until step 5 does not reveal any regular objects</li>
<li>Make a final PLS model using classic estimator for the critical limits</li>
</ol>
<p>If test set validation is used, the outlier detection should be done for both sets. And it is of course important to use optimal number of components, which can be identified using RMSE plot and plot for explained Y-variance.</p>
<p>The code chunks below show the steps for detection of outliers in the People data used in an example earlier. We start with creating PLS model for the whole data.</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="distances-and-outlier-detection.html#cb209-1"></a><span class="co"># prepare data</span></span>
<span id="cb209-2"><a href="distances-and-outlier-detection.html#cb209-2"></a><span class="kw">data</span>(people)</span>
<span id="cb209-3"><a href="distances-and-outlier-detection.html#cb209-3"></a>X =<span class="st"> </span>people[, <span class="dv">-4</span>]</span>
<span id="cb209-4"><a href="distances-and-outlier-detection.html#cb209-4"></a>y =<span class="st"> </span>people[, <span class="dv">4</span>, drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb209-5"><a href="distances-and-outlier-detection.html#cb209-5"></a></span>
<span id="cb209-6"><a href="distances-and-outlier-detection.html#cb209-6"></a><span class="co"># add outliers</span></span>
<span id="cb209-7"><a href="distances-and-outlier-detection.html#cb209-7"></a>y[<span class="dv">9</span>] =<span class="st"> </span><span class="dv">25</span></span>
<span id="cb209-8"><a href="distances-and-outlier-detection.html#cb209-8"></a>X[<span class="dv">1</span>, <span class="dv">1</span>] =<span class="st"> </span><span class="dv">125</span></span>
<span id="cb209-9"><a href="distances-and-outlier-detection.html#cb209-9"></a></span>
<span id="cb209-10"><a href="distances-and-outlier-detection.html#cb209-10"></a><span class="co"># compute initial PLS model with all data</span></span>
<span id="cb209-11"><a href="distances-and-outlier-detection.html#cb209-11"></a>m =<span class="st"> </span><span class="kw">pls</span>(X, y, <span class="dv">10</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">cv =</span> <span class="dv">1</span>, <span class="dt">lim.type =</span> <span class="st">&quot;ddrobust&quot;</span>)</span>
<span id="cb209-12"><a href="distances-and-outlier-detection.html#cb209-12"></a></span>
<span id="cb209-13"><a href="distances-and-outlier-detection.html#cb209-13"></a><span class="co"># look at RMSE and XY-residuals plot</span></span>
<span id="cb209-14"><a href="distances-and-outlier-detection.html#cb209-14"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb209-15"><a href="distances-and-outlier-detection.html#cb209-15"></a><span class="kw">plotRMSE</span>(m)</span>
<span id="cb209-16"><a href="distances-and-outlier-detection.html#cb209-16"></a><span class="kw">plotXYResiduals</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-134-1.png" width="864" /></p>
<p>Apparently four components selected automatically is indeed a proper value. The XY-residuals plot shows that we have two outliers, let’s find and remove them:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="distances-and-outlier-detection.html#cb210-1"></a><span class="co"># get row indices for outliers in calibration set</span></span>
<span id="cb210-2"><a href="distances-and-outlier-detection.html#cb210-2"></a>outliers =<span class="st"> </span><span class="kw">which</span>(<span class="kw">categorize</span>(m, m<span class="op">$</span>res<span class="op">$</span>cal) <span class="op">==</span><span class="st"> &quot;outlier&quot;</span>)</span>
<span id="cb210-3"><a href="distances-and-outlier-detection.html#cb210-3"></a></span>
<span id="cb210-4"><a href="distances-and-outlier-detection.html#cb210-4"></a><span class="co"># keep data for outliers in separate matrices</span></span>
<span id="cb210-5"><a href="distances-and-outlier-detection.html#cb210-5"></a>Xo =<span class="st"> </span>X[outliers, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb210-6"><a href="distances-and-outlier-detection.html#cb210-6"></a>yo =<span class="st"> </span>X[outliers, drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb210-7"><a href="distances-and-outlier-detection.html#cb210-7"></a></span>
<span id="cb210-8"><a href="distances-and-outlier-detection.html#cb210-8"></a><span class="co"># remove the rows with outliers from the data</span></span>
<span id="cb210-9"><a href="distances-and-outlier-detection.html#cb210-9"></a>X =<span class="st"> </span>X[<span class="op">-</span>outliers, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb210-10"><a href="distances-and-outlier-detection.html#cb210-10"></a>y =<span class="st"> </span>y[<span class="op">-</span>outliers, drop =<span class="st"> </span><span class="ot">FALSE</span>]</span>
<span id="cb210-11"><a href="distances-and-outlier-detection.html#cb210-11"></a></span>
<span id="cb210-12"><a href="distances-and-outlier-detection.html#cb210-12"></a><span class="co"># make a new model for oulier free data</span></span>
<span id="cb210-13"><a href="distances-and-outlier-detection.html#cb210-13"></a>m =<span class="st"> </span><span class="kw">pls</span>(X, y, <span class="dv">10</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">cv =</span> <span class="dv">1</span>, <span class="dt">lim.type =</span> <span class="st">&quot;ddrobust&quot;</span>)</span>
<span id="cb210-14"><a href="distances-and-outlier-detection.html#cb210-14"></a></span>
<span id="cb210-15"><a href="distances-and-outlier-detection.html#cb210-15"></a><span class="co"># look at RMSE and XY-residuals plot</span></span>
<span id="cb210-16"><a href="distances-and-outlier-detection.html#cb210-16"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb210-17"><a href="distances-and-outlier-detection.html#cb210-17"></a><span class="kw">plotRMSE</span>(m)</span>
<span id="cb210-18"><a href="distances-and-outlier-detection.html#cb210-18"></a><span class="kw">plotXYResiduals</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-135-1.png" width="864" />
Again, four or three components seem to be optimal and this time no extra outliers are detected. Let’s now apply the model to the two outliers found previously and see their status.</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="distances-and-outlier-detection.html#cb211-1"></a>res =<span class="st"> </span><span class="kw">predict</span>(m, Xo, yo)</span>
<span id="cb211-2"><a href="distances-and-outlier-detection.html#cb211-2"></a><span class="kw">plotXYResiduals</span>(m, <span class="dt">res =</span> <span class="kw">list</span>(<span class="st">&quot;cal&quot;</span> =<span class="st"> </span>m<span class="op">$</span>res<span class="op">$</span>cal, <span class="st">&quot;out&quot;</span> =<span class="st"> </span>res))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-136-1.png" width="432" /></p>
<p>The two objects seem now even more extreme for the model built using the outliers free data, no need to have them back. So we just need to make a final model and look at it:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="distances-and-outlier-detection.html#cb212-1"></a><span class="co"># make a new model for oulier free data and explore it</span></span>
<span id="cb212-2"><a href="distances-and-outlier-detection.html#cb212-2"></a>m =<span class="st"> </span><span class="kw">pls</span>(X, y, <span class="dv">10</span>, <span class="dt">scale =</span> <span class="ot">TRUE</span>, <span class="dt">cv =</span> <span class="dv">1</span>, <span class="dt">lim.type =</span> <span class="st">&quot;ddmoments&quot;</span>)</span>
<span id="cb212-3"><a href="distances-and-outlier-detection.html#cb212-3"></a><span class="kw">summary</span>(m)</span></code></pre></div>
<pre><code>## 
## PLS model (class pls) summary
## -------------------------------
## Info: 
## Number of selected components: 4
## Cross-validation: full (leave one out)
## 
##     X cumexpvar Y cumexpvar    R2  RMSE Slope    Bias  RPD
## Cal     85.9168    97.03856 0.970 0.620 0.970  0.0000 5.91
## Cv           NA          NA 0.945 0.843 0.953 -0.0261 4.35</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="distances-and-outlier-detection.html#cb214-1"></a><span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb214-2"><a href="distances-and-outlier-detection.html#cb214-2"></a><span class="kw">plotXYResiduals</span>(m)</span>
<span id="cb214-3"><a href="distances-and-outlier-detection.html#cb214-3"></a><span class="kw">plotRegcoeffs</span>(m, <span class="dt">type =</span> <span class="st">&quot;h&quot;</span>, <span class="dt">show.labels =</span> <span class="ot">TRUE</span>, <span class="dt">show.ci =</span> <span class="ot">TRUE</span>)</span>
<span id="cb214-4"><a href="distances-and-outlier-detection.html#cb214-4"></a><span class="kw">plotRMSE</span>(m)</span>
<span id="cb214-5"><a href="distances-and-outlier-detection.html#cb214-5"></a><span class="kw">plotPredictions</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-137-1.png" width="864" /></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="variable-selection.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="randomization-test.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 1
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
